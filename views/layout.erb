<!DOCTYPE html>
<html>
<head>
	<title> Robi</title>
	<link rel='stylesheet' href='http://getbootstrap.com/dist/css/bootstrap.min.css'>
	<link rel='stylesheet' href='css/app.css'>
	<link type="text/css" href="/skin/jplayer.blue.monday.css" rel="stylesheet" />
	<link type="text/css" href="/skin/style.css" rel="stylesheet" />
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
</head>

<body>

	<%= erb :header %>
	<div class="container">
		<div class="row">
			<%= erb :text_to_speech %>
			<%= yield %>
			<%= erb :player_audio %>
			<%= erb :vote %>

		</div>
	</div>
	<script src="http://getbootstrap.com/dist/js/bootstrap.min.js"></script>
	<link rel="stylesheet" href="//code.jquery.com/ui/1.10.4/themes/smoothness/jquery-ui.css">
	<script src="js/jquery-ui-1.10.4.custom.min.js"></script>

	<script>
	$(document).ready(function(){
		$("#tracks").sortable({
			axis: "y",
			update: function() {
				var tracks = []
				var new_playlist = []
				$('.jp-playlist-item').each(function(){
					tracks.push($(this).text())
				})
				return $.post($(this).data('update-url'), {'tracks': tracks}, function(data) {
	            	myPlaylist.setPlaylist(JSON.parse(data))
	            })
			}
		});

		$('#jp_container_N .jp-playlist').on('click', 'a.jp-playlist-item-remove', function(){
			var name = $(this).next('.jp-playlist-item').text()
			$.post('http://localhost:9393/remove_track', {name: name}, function() {console.log('ok destroy')})
		})

		rebuildPlaylist = function() {
			console.log('rebuild the playlist')
			myPlaylist.setPlaylist(getCurrentPlaylist())
		}

		getCurrentPlaylist = function() {
			var data = []
			$('.my-playlist .to-my-playlist:checked').each(function(){
				var $mySong = $(this).next('.my-song')
				data.push({title: $mySong.text(), mp3: $mySong.data('lien')})
			})
			return data
		}

		$("#my-tracks").sortable({
			axis: "y",
			update: function() {
				var tracks = []
				$('.my-playlist .my-song').each(function(){
					tracks.push({title: $(this).text(), mp3: $(this).data('lien')})
				})
				console.log(tracks)
				$.post('/sort_url', {'tracks': tracks}, function(data) {
	            	console.log('ok, tri enregistr√©')
	            	rebuildPlaylist()
	            })
			}
		});

		$('.to-my-playlist').on('change', function(event) {
			rebuildPlaylist()
		})

		$('.remove-my-song').on('click', function(event) {
			event.preventDefault()
			var name = $(this).prev('.my-song').text()
			if($(this).parent('li').find('.to-my-playlist').is(':checked')) { 
				rebuildPlaylist()}
			$.post('http://localhost:9393/remove_track', {name: name}, function() {console.log('ok destroy')})
			$(this).parent().remove()
		})
	});
	</script>
	<script type="text/javascript" src="/js/jquery.jplayer.min.js"></script>
	<script type="text/javascript" src="/js/jplayer.playlist.min.js"></script>
</body>
</html>
